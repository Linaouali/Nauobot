---
# ============================================================
# Playbook : SPB Topology Configuration (Control + Data + ISIS)
# Compatible avec le webhook Nautobot SPB_TOPOLOGY
# ============================================================

- name: Configure SPB Topology from Nautobot webhook
  hosts: all
  gather_facts: no
  connection: network_cli
  vars:
    ansible_network_os: ale.aos8.aos8
    ansible_remote_tmp: /tmp/.ansible/tmp

  tasks:

    # --- 1️⃣ Initialisation des variables du webhook ---
    - name: Prepare SPB topology variables
      set_fact:
        topology_name: "{{ topology_name | default('SPB_Topology') }}"
        control_bvlan_id: "{{ control_bvlan_id | default('1000') }}"
        data_bvlans_list: "{{ data_bvlan_ids.split(',') | map('trim') | list }}"
        devices_list: "{{ devices | default([]) }}"
        interfaces_list: "{{ interfaces | default([]) }}"
        iface_type: "{{ iface_type | default('p2p') }}"
        hello_interval: "{{ hello_interval | default(10) | int }}"
        hello_multiplier: "{{ hello_multiplier | default(3) | int }}"
        metric: "{{ metric | default(10) | int }}"
        priority: "{{ priority | default(64) | int }}"
        admin_state: "{{ admin_state | default(true) | bool }}"

    - name: Debug SPB Topology input
      debug:
        msg:
          - "Topology: {{ topology_name }}"
          - "Control BVLAN: {{ control_bvlan_id }}"
          - "Data BVLANs: {{ data_bvlans_list }}"
          - "Devices: {{ devices_list }}"
          - "Interfaces: {{ interfaces_list }}"
          - "SPB Parameters: iface_type={{ iface_type }}, metric={{ metric }}, priority={{ priority }}"

    # --- 2️⃣ Vérification de la cible ---
    - name: Skip hosts not in devices_list
      meta: end_host
      when: inventory_hostname not in devices_list

    - name: Proceed only on target device
      debug:
        msg: "Applying SPB config on {{ inventory_hostname }}"

    # --- 3️⃣ Récupérer la config existante ---
    - name: Show existing SPB BVLANs
      ale.aos8.aos8_command:
        commands:
          - "show spb isis bvlans"
      register: spb_bvlan_output
      ignore_errors: true

    - name: Extract existing BVLANs
      set_fact:
        existing_bvlans: "{{ spb_bvlan_output.stdout[0] | regex_findall('([0-9]+)') | unique | default([]) }}"
      when: spb_bvlan_output is defined and spb_bvlan_output.stdout is defined

    # --- 4️⃣ Créer le BVLAN contrôle ---
    - name: Create Control BVLAN if missing
      ale.aos8.aos8_config:
        lines:
          - "spb bvlan {{ control_bvlan_id }}"
          - "spb isis control-bvlan {{ control_bvlan_id }}"
          - "spb isis admin-state enable"
        save_when: changed
      when: control_bvlan_id not in existing_bvlans | default([])

    - name: Skip existing Control BVLAN
      debug:
        msg: "Control BVLAN {{ control_bvlan_id }} already exists"
      when: control_bvlan_id in existing_bvlans | default([])

    # --- 5️⃣ Créer les BVLANs data ---
    - name: Configure Data BVLANs if missing
      ale.aos8.aos8_config:
        lines:
          - "spb bvlan {{ item }}"
          - "spb isis bvlan {{ item }} ect-id 1"
          - "spb isis bvlan {{ item }} tandem-multicast-mode sgmode"
        save_when: changed
      loop: "{{ data_bvlans_list }}"
      when: item not in existing_bvlans | default([])

    # --- 6️⃣ Configurer les interfaces locales ---
    - name: Configure SPB ISIS interfaces on this device
      ale.aos8.aos8_config:
        lines: >-
          {% for intf in interfaces_list %}
          {% set dev = intf.split(':')[0] %}
          {% set port = intf.split(':')[1] %}
          {% if dev == inventory_hostname %}
          spb isis interface port {{ port }}
          spb isis interface port {{ port }} admin-state {{ 'enable' if admin_state else 'disable' }}
          spb isis interface port {{ port }} type {{ iface_type }}
          spb isis interface port {{ port }} hello-interval {{ hello_interval }}
          spb isis interface port {{ port }} hello-multiplier {{ hello_multiplier }}
          spb isis interface port {{ port }} metric {{ metric }}
          spb isis interface port {{ port }} priority {{ priority }}
          {% endif %}
          {% endfor %}
        save_when: changed

    # --- 7️⃣ Sauvegarde ---
    - name: Save configuration
      ale.aos8.aos8_config:
        lines:
          - "write memory"

