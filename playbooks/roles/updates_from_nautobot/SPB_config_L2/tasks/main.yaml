---
# ============================================================
# Role: SPB_config_L2
# Description: Configure SPB ISIS interface and create BVLAN if missing
# ============================================================

# --- 1️⃣ Variables dynamiques issues du webhook Nautobot ---
- name: Prepare SPB interface variables
  set_fact:
    spb_isis_lines: []
    spb_interface: "{{ interface_id }}"
    spb_bvlan_id: "{{ bvlan_id }}"
    spb_iface_type: "{{ iface_type | default('p2p') }}"
    spb_hello_interval: "{{ hello_interval | default(10) }}"
    spb_hello_multiplier: "{{ hello_multiplier | default(3) }}"
    spb_metric: "{{ metric | default(10) }}"
    spb_priority: "{{ priority | default(64) }}"
    spb_admin_state: "{{ admin_state | default(true) }}"
    target_device: "{{ device_id | default(inventory_hostname) }}"

- name: Debug received variables
  debug:
    msg:
      - "Target device: {{ target_device }}"
      - "Interface: {{ spb_interface }}"
      - "BVLAN: {{ spb_bvlan_id }}"
      - "Admin state: {{ spb_admin_state }}"
      - "Type: {{ spb_iface_type }}"

# --- 2️⃣ Vérifie si le BVLAN existe déjà ---
- name: Check existing SPB BVLANS
  ale.aos8.aos8_command:
    commands:
      - "show spb isis bvlans"
  register: spb_bvlan_output
  ignore_errors: true

- name: Determine if BVLAN exists
  set_fact:
    bvlan_exists: "{{ spb_bvlan_id | string in spb_bvlan_output.stdout[0] | default('') }}"

# --- 3️⃣ Crée le BVLAN s’il n’existe pas ---
- name: Ensure SPB BVLAN exists
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ spb_bvlan_id }} admin-state enable"
    save_when: changed
  when: not bvlan_exists

# --- 4️⃣ Construit la configuration de l’interface ISIS ---
- name: Build SPB ISIS interface config
  set_fact:
    spb_isis_lines:
      - "spb isis interface port {{ spb_interface }} admin-state {{ 'enable' if spb_admin_state else 'disable' }}"
      - "spb isis interface port {{ spb_interface }} type {{ spb_iface_type }}"
      - "spb isis interface port {{ spb_interface }} hello-interval {{ spb_hello_interval }}"
      - "spb isis interface port {{ spb_interface }} hello-multiplier {{ spb_hello_multiplier }}"
      - "spb isis interface port {{ spb_interface }} metric {{ spb_metric }}"
      - "spb isis interface port {{ spb_interface }} priority {{ spb_priority }}"
  when: spb_interface is defined and spb_bvlan_id is defined

# --- 5️⃣ Applique la configuration ISIS ---
- name: Apply SPB ISIS interface configuration
  ale.aos8.aos8_config:
    lines: "{{ spb_isis_lines }}"
    save_when: changed
  when: spb_isis_lines is defined and spb_isis_lines | length > 0

# --- 6️⃣ Sauvegarde la configuration ---
- name: Save configuration
  ale.aos8.aos8_config:
    lines:
      - "write memory"

