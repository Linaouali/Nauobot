---
# ============================================================
# Role: SPB_config_L2
# Description: Configure SPB Topology (Control + Data BVLANs + ISIS + Interfaces)
# Triggered by Nautobot Webhook (create/update)
# ============================================================



# --- Initialization of variables from the webhook ---
- name: Prepare SPB Topology variables
  set_fact:
    topology_name: "{{ topology_name | default('SPB_Topology') }}"
    action_type: "{{ action | default('update') }}"
    control_bvlan_id: "{{ control_bvlan_id | default('1000') }}"
    data_bvlans_list: "{{ data_bvlan_ids.split(',') | map('trim') | list }}"
    devices_list: "{{ devices | default([]) }}"
    interfaces_list: "{{ interfaces | default([]) }}"
    iface_type: "{{ iface_type | default('multi-access') }}"
    hello_interval: "{{ hello_interval | default(3) | int }}"
    hello_multiplier: "{{ hello_multiplier | default(3) | int }}"
    metric: "{{ metric | default(10) | int }}"
    priority: "{{ priority | default(1) | int }}"
    admin_state: "{{ admin_state | default(true) | bool }}"
    ansible_network_os: "{{ ansible_network_os | default('ale.aos8.aos8') }}"

# --- Debug at AWX output 
- name: Show received webhook data
  debug:
    msg:
      - "Webhook Action: {{ action_type }}"
      - "Topology: {{ topology_name }}"
      - "Control BVLAN: {{ control_bvlan_id }}"
      - "Data BVLANs: {{ data_bvlans_list }}"
      - "Devices: {{ devices_list }}"
      - "Interfaces: {{ interfaces_list }}"
  tags: debug


# --- input validation ---
- name: Ensure we have devices and interfaces
  fail:
    msg: "No devices or interfaces received from Nautobot!"
  when: devices_list | length == 0 or interfaces_list | length == 0


# --- Retrieve the existing state of the switch ---
- name: Retrieve current SPB configuration
  ale.aos8.aos8_command:
    commands:
      - "show spb isis bvlans"
      - "show spb isis interface"
  register: current_spb
  ignore_errors: true
  when: inventory_hostname in devices_list

- name: Extract existing BVLAN IDs and interfaces
  set_fact:
    existing_bvlans: "{{ current_spb.stdout[0] | regex_findall('([0-9]+)') | unique | default([]) }}"
    existing_interfaces: "{{ current_spb.stdout[1] | regex_findall('port ([0-9]+/[0-9]+/[0-9]+)') | unique | default([]) }}"
  when: current_spb is defined




# --- configure BVLANs ---
# --- control BVLANs ---
- name: Configure SPB Control BVLAN (only if  action=create)
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ control_bvlan_id }}"
      - "spb isis control-bvlan {{ control_bvlan_id }}"
  when: inventory_hostname in devices_list and (action_type == "created")
  register: ctrl_bvlan_result
  ignore_errors: true
  tags: control_bvlan

#--- DATA BVLANs ---
- name: Configure SPB Data BVLANs (only if missing or action=create)
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ item }}"
     # - "spb isis bvlan {{ item }} ect-id 1"
     # - "spb isis bvlan {{ item }} tandem-multicast-mode sgmode"
  loop: "{{ data_bvlans_list }}"
  when: inventory_hostname in devices_list and (action_type == "created" or item not in existing_bvlans)
  register: data_bvlan_result
  ignore_errors: true
  tags: data_bvlan

