---
# ============================================================
# Role: SPB_config_L2
# Description: Configure SPB Topology (Control + Data BVLANs + ISIS + Interfaces)
# Triggered by Nautobot Webhook (create/update)
# ============================================================

- meta: end_host
  when: role != "SPB_TOPOLOGY"


# --- Initialization of variables from the webhook ---
- name: Prepare SPB Topology variables
  set_fact:
    topology_name: "{{ topology_name | default('SPB_Topology') }}"
    action_type: "{{ action | default('update') }}"
    control_bvlan_id: "{{ control_bvlan_id | default('1000') }}"
    data_bvlans_list: "{{ data_bvlan_ids.split(',') | map('trim') | list }}"
    devices_list: "{{ devices | default([]) }}"
    interfaces_list: "{{ interfaces | default([]) }}"
    iface_type: "{{ iface_type | default('multi-access') }}"
    hello_interval: "{{ hello_interval | default(3) | int }}"
    hello_multiplier: "{{ hello_multiplier | default(3) | int }}"
    metric: "{{ metric | default(10) | int }}"
    priority: "{{ priority | default(1) | int }}"
    admin_state: "{{ admin_state | default(true) | bool }}"
    ansible_network_os: "{{ ansible_network_os | default('ale.aos8.aos8') }}"

# --- Debug at AWX output 
- name: Show received webhook data
  debug:
    msg:
      - "Webhook Action: {{ action_type }}"
      - "Topology: {{ topology_name }}"
      - "Control BVLAN: {{ control_bvlan_id }}"
      - "Data BVLANs: {{ data_bvlans_list }}"
      - "Devices: {{ devices_list }}"
      - "Interfaces: {{ interfaces_list }}"
  tags: debug


# --- input validation ---
- name: Ensure we have devices and interfaces
  fail:
    msg: "No devices or interfaces received from Nautobot!"
  when: devices_list | length == 0 or interfaces_list | length == 0


# --- Retrieve the existing state of the switch ---
- name: Retrieve current SPB configuration
  ale.aos8.aos8_command:
    commands:
      - "show spb isis bvlans"
      - "show spb isis interface"
  register: current_spb
  ignore_errors: true
  when: inventory_hostname in devices_list

- name: Extract existing BVLAN IDs and interfaces
  set_fact:
    existing_bvlans: "{{ current_spb.stdout[0] | regex_findall('([0-9]+)') | unique | default([]) }}"
    existing_interfaces: "{{ current_spb.stdout[1] | regex_findall('port ([0-9]+/[0-9]+/[0-9]+)') | unique | default([]) }}"
  when: current_spb is defined




# --- configure BVLANs ---
# --- control BVLANs ---
- name: Configure SPB Control BVLAN (only if  action=create)
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ control_bvlan_id }}"
      - "spb isis control-bvlan {{ control_bvlan_id }}"
  when: inventory_hostname in devices_list and (action_type == "created")
  register: ctrl_bvlan_result
  ignore_errors: true
  tags: control_bvlan

#--- DATA BVLANs ---
- name: Configure SPB Data BVLANs (only if missing or action=create)
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ item }}"
     # - "spb isis bvlan {{ item }} ect-id 1"
     # - "spb isis bvlan {{ item }} tandem-multicast-mode sgmode"
  loop: "{{ data_bvlans_list }}"
  when: inventory_hostname in devices_list and (action_type == "created" or item not in existing_bvlans)
  register: data_bvlan_result
  ignore_errors: true
  tags: data_bvlan



# --- Configure the ISIS interfaces ---
- name: Select interfaces for this device
  set_fact:
    local_interfaces: "{{ interfaces_list | select('match', inventory_hostname ~ ':') | list }}"
  when: inventory_hostname in devices_list

- name: Configure SPB ISIS interfaces for this device (skip existing if update)
  ale.aos8.aos8_config:
    lines: |
      {% for intf in local_interfaces %}
      {% set port = intf.split(':')[1] %}
      {% if action_type == "created" or port not in existing_interfaces %}
      spb isis interface port {{ port }}
      spb isis interface port {{ port }} type {{ iface_type }}
      spb isis interface port {{ port }} hello-interval {{ hello_interval }}
      spb isis interface port {{ port }} hello-multiplier {{ hello_multiplier }}
      spb isis interface port {{ port }} metric {{ metric }}
      spb isis interface port {{ port }} priority {{ priority }}
      spb isis interface port {{ port }} admin-state {{ 'enable' if admin_state else 'disable' }}
      {% endif %}
      {% endfor %}
  when: local_interfaces | length > 0
  register: intf_config_result
  ignore_errors: true
  tags: spb_interfaces

- debug:
    msg: "{{ intf_config_result }}"


# --- Enable ISIS globally (if new or update) ---
- name: Enable SPB ISIS globally
  ale.aos8.aos8_config:
    lines:
      - "spb isis admin-state enable"
  when: inventory_hostname in devices_list and (action_type == "created" or "'admin-state enable'" not in current_spb.stdout[1])
  register: enable_isis_result
  ignore_errors: true
  tags: isis



# --- Save Config ---
- name: Save SPB configuration
  ale.aos8.aos8_config:
    lines:
      - "write memory flash-synchro"
  when: inventory_hostname in devices_list
  register: save_result
  ignore_errors: true
  tags: save



# --- GIT ---

# --- Collect full running configuration ---
- name: Collect full running configuration
  ale.aos8.aos8_command:
    commands:
      - "show configuration snapshot"
  when: inventory_hostname in devices_list and
        (ctrl_bvlan_result.changed or
         data_bvlan_result.changed or
         intf_config_result.changed or
         enable_isis_result.changed)
  register: full_config


# --- Ensure local config directory exists ---
- name: Ensure config_device directory exists
  file:
    path: "/home/automation/awx-operator/ansible/config_device"
    state: directory
    mode: '0755'
  delegate_to: localhost


# --- Save config to local file ---
- name: Save config to local file
  copy:
    content: "{{ full_config.stdout[0] }}"
    dest: "/home/automation/awx-operator/ansible/config_device/{{ inventory_hostname }}_{{ lookup('pipe', 'date +%Y-%m-%d_%H-%M-%S') }}.cfg"
  when: full_config.stdout is defined
  delegate_to: localhost


# --- Configure Git ---
- name: Ensure Git user is defined
  shell: |
    cd /home/automation/awx-operator/ansible/config_device
    git config user.email "linaouali547@gmail.com"
    git config user.name "linaouali547@gmail.com"
  delegate_to: localhost


# --- Commit & Push changes to Git ---
- name: Commit device config to Git
  shell: |
    cd /config_device
    git add .
    git commit -m "Update config {{ inventory_hostname }} at {{ lookup('pipe', 'date') }}"
    git push
  when: full_config.stdout is defined
  delegate_to: localhost

