---
# ============================================================
# Role: update_spb_interface
# Description: Configure SPB ISIS interface and create BVLAN if missing
# ============================================================

# --- Variables dynamiques issues du webhook Nautobot ---
- name: Prepare SPB interface variables
  set_fact:
    spb_interface: "{{ interface_id }}"
    spb_bvlan_id: "{{ bvlan_id }}"
    spb_iface_type: "{{ iface_type | default('p2p') }}"
    spb_hello_interval: "{{ hello_interval | default(10) }}"
    spb_hello_multiplier: "{{ hello_multiplier | default(3) }}"
    spb_metric: "{{ metric | default(10) }}"
    spb_priority: "{{ priority | default(64) }}"
    spb_admin_state: "{{ admin_state | default(true) }}"

# --- Vérifie si le BVLAN existe ---
- name: Check existing SPB BVLANS
  ale.aos8.aos8_command:
    commands:
      - "show spb isis bvlans"
  register: spb_bvlan_output
  ignore_errors: true

- name: Determine if BVLAN exists
  set_fact:
    bvlan_exists: "{{ spb_bvlan_id | string in spb_bvlan_output.stdout[0] }}"

# --- Crée le BVLAN si nécessaire ---
- name: Ensure SPB BVLAN exists
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ spb_bvlan_id }} admin-state enable"
    save_when: changed
  when: not bvlan_exists

# --- Configure l’interface SPB ISIS ---
- name: Build SPB ISIS interface config
  set_fact:
    spb_isis_lines:
      - "spb isis interface port {{ spb_interface }} admin-state {{ 'enable' if spb_admin_state else 'disable' }}"
      - "spb isis interface port {{ spb_interface }} type {{ spb_iface_type }}"
      - "spb isis interface port {{ spb_interface }} hello-interval {{ spb_hello_interval }}"
      - "spb isis interface port {{ spb_interface }} hello-multiplier {{ spb_hello_multiplier }}"
      - "spb isis interface port {{ spb_interface }} metric {{ spb_metric }}"
      - "spb isis interface port {{ spb_interface }} priority {{ spb_priority }}"

- name: Apply SPB ISIS interface configuration
  ale.aos8.aos8_config:
    lines: "{{ spb_isis_lines }}"
    save_when: changed

# --- Sauvegarde de la configuration ---
- name: Save configuration
  ale.aos8.aos8_config:
    lines:
      - "write memory"

