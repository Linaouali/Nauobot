---
# ============================================================
# Role: SPB_config_L2
# Description: Configure SPB ISIS interface and BVLAN
# ============================================================

# --- 0️⃣ Skip non-target devices ---
- name: Check if current device matches target
  set_fact:
    target_match: "{{ (inventory_hostname == device_id) | default(false) }}"

- name: Skip non-target devices
  debug:
    msg: "Skipping {{ inventory_hostname }} (target is {{ device_id }})"
  when: not target_match
  changed_when: false
  tags: skip

- name: Stop processing on non-target devices
  meta: end_host
  when: not target_match


# --- 1️⃣ Initialisation des variables dynamiques issues du webhook ---
- name: Prepare SPB variables
  set_fact:
    ansible_network_os: "{{ ansible_network_os | default('ale.aos8.aos8') }}"
    spb_interface: "{{ interface_id }}"
    spb_bvlan_id: "{{ bvlan_id }}"
    spb_bvlan_name: "{{ name | default('BVLAN-' + (bvlan_id | string)) }}"
    spb_ect_id: "{{ ect_id | default(1) }}"
    spb_tandem_mode: "{{ tandem_multicast_mode | default('sgmode') }}"
    spb_iface_type: "{{ iface_type | default('p2p') }}"
    spb_hello_interval: "{{ hello_interval | default(10) }}"
    spb_hello_multiplier: "{{ hello_multiplier | default(3) }}"
    spb_metric: "{{ metric | default(10) }}"
    spb_priority: "{{ priority | default(64) }}"
    spb_admin_state: "{{ admin_state | default(true) }}"
    spb_control: "{{ control | default(false) }}"
    spb_description: "{{ description | default('SPB BVLAN ' + (bvlan_id | string)) }}"

- name: Debug SPB input values
  debug:
    msg:
      - "Target device: {{ device_id }}"
      - "Interface: {{ spb_interface }}"
      - "BVLAN: {{ spb_bvlan_id }}"
      - "Name: {{ spb_bvlan_name }}"
      - "ECT-ID: {{ spb_ect_id }}"
      - "Tandem mode: {{ spb_tandem_mode }}"
      - "Control: {{ spb_control }}"
      - "Admin state: {{ spb_admin_state }}"
      - "Type: {{ spb_iface_type }}"


# --- 2️⃣ Vérifier si le BVLAN existe déjà ---
- name: Check existing SPB BVLANS
  ale.aos8.aos8_command:
    commands:
      - "show spb isis bvlans"
  register: spb_bvlan_output
  ignore_errors: true

- name: Determine if BVLAN exists
  set_fact:
    bvlan_exists: >-
      {{
        (spb_bvlan_output is defined and
         spb_bvlan_output.stdout is defined and
         spb_bvlan_output.stdout | length > 0 and
         (spb_bvlan_id | string in spb_bvlan_output.stdout[0]))
         | default(false)
      }}

- name: Debug BVLAN existence
  debug:
    msg: "BVLAN {{ spb_bvlan_id }} exists: {{ bvlan_exists }}"


# --- 3️⃣ Créer ou mettre à jour le BVLAN complet ---
- name: Create or update SPB BVLAN
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ spb_bvlan_id }} name {{ spb_bvlan_name }}"
      - "spb bvlan {{ spb_bvlan_id }} admin-state enable"
      - "spb bvlan {{ spb_bvlan_id }} ect-algorithm {{ spb_ect_id }}"
      - "spb bvlan {{ spb_bvlan_id }} tandem-multicast-mode {{ spb_tandem_mode }}"
    save_when: changed


# --- 4️⃣ Si BVLAN contrôle, activer ISIS sur ce BVLAN ---
- name: Configure SPB ISIS control BVLAN if applicable
  ale.aos8.aos8_config:
    lines:
      - "spb isis control-bvlan {{ spb_bvlan_id }}"
      - "spb isis admin-state enable"
    save_when: changed
  when: spb_control | bool


# --- 5️⃣ Configurer l’interface SPB ISIS ---
- name: Configure SPB ISIS interface
  ale.aos8.aos8_config:
    lines:
      - "spb isis interface port {{ spb_interface }} admin-state {{ 'enable' if spb_admin_state else 'disable' }}"
      - "spb isis interface port {{ spb_interface }} type {{ spb_iface_type }}"
      - "spb isis interface port {{ spb_interface }} hello-interval {{ spb_hello_interval }}"
      - "spb isis interface port {{ spb_interface }} hello-multiplier {{ spb_hello_multiplier }}"
      - "spb isis interface port {{ spb_interface }} metric {{ spb_metric }}"
      - "spb isis interface port {{ spb_interface }} priority {{ spb_priority }}"
    save_when: changed


# --- 6️⃣ Sauvegarder la configuration ---
- name: Save configuration
  ale.aos8.aos8_config:
    lines:
      - "write memory"

