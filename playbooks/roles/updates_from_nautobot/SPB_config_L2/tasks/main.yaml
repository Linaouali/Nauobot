---
# ============================================================
# Role: SPB_config_L2
# Description: Configure SPB Topology (Control + Data BVLANs, ISIS, Interfaces)
# ============================================================

# --- 1️⃣ Initialisation des variables issues du webhook ---
- name: Prepare SPB Topology variables
  set_fact:
    topology_name: "{{ topology_name | default('SPB_Topology') }}"
    control_bvlan_id: "{{ control_bvlan_id | default('1000') }}"
    data_bvlans_list: "{{ data_bvlan_ids.split(',') | map('trim') | list }}"
    devices_list: "{{ devices | default([]) }}"
    interfaces_list: "{{ interfaces | default([]) }}"
    iface_type: "{{ iface_type | default('p2p') }}"
    hello_interval: "{{ hello_interval | default(10) | int }}"
    hello_multiplier: "{{ hello_multiplier | default(3) | int }}"
    metric: "{{ metric | default(10) | int }}"
    priority: "{{ priority | default(64) | int }}"
    admin_state: "{{ admin_state | default(true) | bool }}"
    ansible_network_os: "{{ ansible_network_os | default('ale.aos8.aos8') }}"

- name: Debug SPB topology input
  debug:
    msg:
      - "Topology: {{ topology_name }}"
      - "Control BVLAN: {{ control_bvlan_id }}"
      - "Data BVLANs: {{ data_bvlans_list }}"
      - "Devices in topology: {{ devices_list }}"
      - "Interfaces in topology: {{ interfaces_list }}"
      - "SPB Parameters: iface_type={{ iface_type }}, hello={{ hello_interval }}, metric={{ metric }}"


# --- 2️⃣ Vérifier les BVLAN existants ---
- name: Show existing SPB BVLANs
  ale.aos8.aos8_command:
    commands:
      - "show spb isis bvlans"
  register: current_spb_bvlans
  ignore_errors: true

- name: Extract existing BVLAN IDs
  set_fact:
    existing_bvlans: "{{ current_spb_bvlans.stdout[0] | regex_findall('([0-9]+)') | unique | default([]) }}"
  when: current_spb_bvlans is defined and current_spb_bvlans.stdout is defined

- name: Debug existing BVLANs
  debug:
    msg: "Existing BVLANs on {{ inventory_hostname }}: {{ existing_bvlans }}"


# --- 3️⃣ Créer le BVLAN contrôle s’il n’existe pas ---
- name: Configure SPB Control BVLAN
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ control_bvlan_id }}"
      - "spb isis control-bvlan {{ control_bvlan_id }}"
    save_when: changed
  when: control_bvlan_id not in existing_bvlans

- name: Skip Control BVLAN (already exists)
  debug:
    msg: "Control BVLAN {{ control_bvlan_id }} already exists"
  when: control_bvlan_id in existing_bvlans


# --- 4️⃣ Créer les BVLANs Data ---
- name: Configure SPB Data BVLANs
  ale.aos8.aos8_config:
    lines:
      - "spb bvlan {{ item }}"
      - "spb isis bvlan {{ item }} ect-id 1"
      - "spb isis bvlan {{ item }} tandem-multicast-mode sgmode"
    save_when: changed
  loop: "{{ data_bvlans_list }}"
  when: item not in existing_bvlans

- name: Skip existing Data BVLANs
  debug:
    msg: "Data BVLAN {{ item }} already exists"
  loop: "{{ data_bvlans_list }}"
  when: item in existing_bvlans


# --- 5️⃣ Activer ISIS globalement ---
- name: Enable SPB ISIS globally
  ale.aos8.aos8_config:
    lines:
      - "spb isis admin-state enable"
    save_when: changed


# --- 6️⃣ Configurer les interfaces ISIS ---
- name: Configure SPB ISIS interfaces for this device
  when: inventory_hostname in devices_list
  ale.aos8.aos8_config:
    lines: >-
      {% for intf in interfaces_list if intf.split(':')[0] == inventory_hostname %}
      spb isis interface port {{ intf.split(':')[1] }}
      spb isis interface port {{ intf.split(':')[1] }} type {{ iface_type }}
      spb isis interface port {{ intf.split(':')[1] }} hello-interval {{ hello_interval }}
      spb isis interface port {{ intf.split(':')[1] }} hello-multiplier {{ hello_multiplier }}
      spb isis interface port {{ intf.split(':')[1] }} metric {{ metric }}
      spb isis interface port {{ intf.split(':')[1] }} priority {{ priority }}
      spb isis interface port {{ intf.split(':')[1] }} admin-state {{ 'enable' if admin_state else 'disable' }}
      {% endfor %}
    save_when: changed


# --- 7️⃣ Sauvegarder la configuration ---
- name: Save SPB configuration
  ale.aos8.aos8_config:
    lines:
      - "write memory"

