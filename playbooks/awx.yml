---
- name: Interface Update
  hosts: "{{ device_id }}"
  gather_facts: no
  vars:
    ansible_remote_tmp: /tmp/.ansible/tmp

  tasks:

    - name: Ensure IP address is defined
      debug:
        msg: "ip_address is empty, skipping CIDR processing"
      when: ip_address is not defined or ip_address == ""

    - name: Derive address and mask from CIDR
      set_fact:
        l3_addr: "{{ ip_address.split('/')[0] }}"
        l3_mask: "{{ ip_address.split('/')[1] | int }}"
      when: ip_address is defined and ip_address != ""

    - name: Debug derived values
      debug:
        msg: "Device {{ inventory_hostname }} -> addr={{ l3_addr | default('N/A') }}, mask={{ l3_mask | default('N/A') }}"

    - name: Run L3 interfaces resource module with state merged
      ale.aos8.aos8_l3_interfaces:
        config:
          - name: "{{ interface_id }}"
            description: "{{ description | default('') }}"
            enabled: "{{ enabled | default(true) | bool }}"
            ipv4: >-
              {{
                [
                  {
                    'address': l3_addr,
                    'mask': l3_mask
                  }
                ]
                if (ip_address is defined and ip_address != "")
                else []
              }}
        state: merged
      when: ip_address is defined and ip_address != ""

